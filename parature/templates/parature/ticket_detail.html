{% extends 'base.html' %}
{% load jsonify %}
{% load htmlify %}

{% block script %}
$(document).ready(function() {
    // Start the page with the informational/system event rows in the ticket history hidden
    $('tr.info').toggle();
    $('button#toggle-info').click(function() {
        $('tr.info').toggle();
    });
});
{% endblock %}

{% block content %}
    <div class="ticket">
            <h3>Customer: <a href="{{ ticket.customerid.get_absolute_url }}">{{ ticket.customerid.first_name }} {{ ticket.customerid.last_name }}</a></h3>
        <div>
            <h3>Ticket Details</h3>
            <h4>Ticket ID: <a href="https://s3.parature.com/link/desk/5525/5563/Ticket/{{ ticket.ticketid }}">{{ ticket.ticketid }}</a> (Parature link)</h4>
            <h4>Summary</h4>
            <div class="ticket_textfield">{{ ticket.summary }}</div>
            <h4>Details</h4>
            <div class="ticket_textfield">{{ ticket.details|safe }}</div>
            <h4>Solution</h4>
            <div class="ticket_textfield">{% if ticket.solution %}{{ ticket.solution|safe }}{% else %}(Solution left blank.){% endif %}</div>
            <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#details">Toggle Details</button>
            <div id="details" class="collapse">
                <pre>{{ ticket|jsonify }}</pre>
            </div>
        </div>
        <div>
            <h3>Ticket Comments</h3>
            <div>
                <button type="button" class="btn btn-info" id="toggle-info">Toggle system events</button>
            </div>
            <table class="table table-hover table-condensed table-bordered">
                <thead>
                    <th>Action Date</th>
                    <th>Action Type</th>
                    <th>CSR</th>
                    <th>Time Spent (hrs)</th>
                    <th>Comments</th>
                </thead>
                <tfoot>
                    <th>Action Date</th>
                    <th>Action Type</th>
                    <th>CSR</th>
                    <th>Time Spent (hrs)</th>
                    <th>Comments</th>
                </tfoot>
                <tbody>
                    {% for h in ticket.tickethistory_set.all %}
                    {% if h.action_name == "Grab Ticket" or h.action_name == "Change Value" or h.action_name == "Feedback follow up - fac" or h.action_name == "Change Value" or h.action_name == "Auto-close Solved Faculty" %}
                    <tr class="info">
                    {% elif h.action_name == "Solve" %}
                    <tr class="success">
                    {% elif h.action_name == "Decline Solution" %}
                    <tr class="danger">
                    {% else %}
                    <tr>
                    {% endif %}
                        <td>{{ h.action_date }}</td>
                        <td>{{ h.action_name }}</td>
                        <td><a href="{% url 'csr_detail' csr=h.performed_by_csr %}">{{ h.performed_by_csr }}</a></td>
                        <td>{{ h.time_spent|floatformat:"-3" }}</td>
                        <td>{{ h.comments|htmlify|safe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
